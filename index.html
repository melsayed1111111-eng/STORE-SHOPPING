<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SHOPPING - Ø³ÙˆÙ‚ Ø²Ø±Ø§Ø¹ÙŠ Ù…ÙØªÙˆØ­</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Ù…ÙƒØªØ¨Ø§Øª ÙÙŠØ±Ø¨Ø§Ø³ -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root {
            --primary: #232f3e;
            --secondary: #febd69;
            --green-brand: #2e7d32;
            --light: #f3f3f3;
            --dark: #111;
            --white: #fff;
            --shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
        }

        body {
            background-color: #eaeded;
            color: var(--dark);
        }

        /* Header */
        header {
            background-color: var(--primary);
            color: white;
            padding: 10px 0;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-main {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            height: 60px;
            gap: 20px;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .logo span {
            color: var(--secondary);
        }

        .search-bar {
            flex-grow: 1;
            display: flex;
            max-width: 800px;
            border-radius: 4px;
            overflow: hidden;
        }

        .search-bar input {
            width: 100%;
            padding: 10px;
            border: none;
            outline: none;
        }

        .search-bar button {
            background: var(--secondary);
            border: none;
            padding: 0 20px;
            cursor: pointer;
            color: var(--primary);
            font-size: 1.2rem;
        }

        .nav-icons {
            display: flex;
            align-items: center;
            gap: 25px;
        }

        .nav-item {
            color: white;
            text-decoration: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 0.8rem;
            cursor: pointer;
            position: relative;
        }

        .nav-item span {
            font-weight: bold;
        }

        .badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--secondary);
            color: var(--primary);
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 0.7rem;
            font-weight: bold;
        }

        /* Ø´Ø±ÙŠØ· Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª */
        .sub-header {
            background-color: #37475a;
            color: white;
            padding: 8px 20px;
            display: flex;
            gap: 15px;
            font-size: 0.95rem;
            overflow-x: auto;
            white-space: nowrap;
            scrollbar-width: thin;
        }

        .cat-link {
            cursor: pointer;
            padding: 2px 8px;
            border-radius: 3px;
            transition: 0.3s;
        }

        .cat-link:hover,
        .cat-link.active {
            background-color: var(--secondary);
            color: var(--primary);
            font-weight: bold;
        }

        /* Slider */
        .slider-container {
            position: relative;
            width: 100%;
            height: 400px;
            overflow: hidden;
            background: linear-gradient(to bottom, #eaeded00 70%, #eaeded 100%);
        }

        .slide {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 1s ease;
            background-size: cover;
            background-position: center;
        }

        .slide.active {
            opacity: 1;
        }

        .slide::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to right, rgba(0, 0, 0, 0.6) 0%, rgba(0, 0, 0, 0) 50%);
        }

        .slide-content {
            position: absolute;
            top: 50%;
            right: 5%;
            transform: translateY(-50%);
            z-index: 2;
            color: white;
            max-width: 500px;
            text-align: right;
        }

        .slide-content h2 {
            font-size: 3rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .slide-btn {
            padding: 10px 30px;
            background: var(--secondary);
            color: var(--primary);
            border: none;
            font-weight: bold;
            cursor: pointer;
            border-radius: 4px;
            font-size: 1.1rem;
        }

        /* Products */
        .main-container {
            padding: 20px;
            max-width: 1400px;
            margin: -50px auto 0;
            position: relative;
            z-index: 10;
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 20px;
        }

        .card {
            background: white;
            padding: 15px;
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            transition: 0.3s;
            border: 1px solid #ddd;
            height: 100%;
        }

        .card:hover {
            transform: scale(1.02);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .card-img {
            width: 100%;
            height: 200px;
            object-fit: contain;
            margin-bottom: 10px;
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 5px;
            line-height: 1.3;
            height: 45px;
            overflow: hidden;
        }

        .merchant-badge {
            font-size: 0.8rem;
            color: #565959;
            margin-bottom: 5px;
        }

        .merchant-badge i {
            color: var(--green-brand);
        }

        .cat-badge {
            font-size: 0.75rem;
            background: #eee;
            padding: 2px 6px;
            border-radius: 4px;
            color: #555;
            display: inline-block;
            margin-bottom: 5px;
        }

        .price {
            font-size: 1.4rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .btn-add {
            background: #f7ca00;
            border: 1px solid #fcd200;
            padding: 8px;
            width: 100%;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            margin-top: auto;
        }

        .btn-add:hover {
            background: #f3a847;
        }

        /* Forms & Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }

        .close-modal {
            position: absolute;
            left: 20px;
            top: 20px;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .btn-primary {
            background: var(--green-brand);
            color: white;
            border: none;
            padding: 10px 20px;
            width: 100%;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1.1rem;
        }

        .btn-instapay {
            background: #5a2d81;
            color: white;
            border: none;
            padding: 10px;
            width: 100%;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
        }

        /* Merchant Panel */
        .merchant-panel {
            background: white;
            padding: 20px;
            margin: 20px auto;
            max-width: 1000px;
            border-radius: 8px;
            display: none;
            border-top: 5px solid var(--green-brand);
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        /* Instapay */
        .paywall-msg {
            text-align: center;
            border: 2px dashed var(--green-brand);
            padding: 20px;
            border-radius: 10px;
            background: #f1f8e9;
            margin-top: 20px;
        }

        .instapay-logo {
            width: 100px;
            margin: 10px auto;
            display: block;
        }

        /* Dispatch Modal Styles (Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª) */
        .order-split-item {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            background: #fafafa;
        }

        .order-split-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-weight: bold;
            color: var(--primary);
        }

        .whatsapp-btn {
            background: #25D366;
            color: white;
            padding: 8px 15px;
            text-decoration: none;
            border-radius: 5px;
            display: inline-block;
            font-weight: bold;
            margin-top: 10px;
            width: 100%;
            text-align: center;
        }

        .whatsapp-btn:hover {
            background: #128C7E;
        }

        footer {
            background: var(--primary);
            color: #ddd;
            padding: 40px 0;
            margin-top: 50px;
            text-align: center;
            font-size: 0.9rem;
        }
    </style>
</head>

<body>

    <!-- Header -->
    <header>
        <div class="header-main">
            <a href="#" class="logo"><i class="fas fa-leaf" style="color:var(--green-brand)"></i> GREEN
                <span>SHOPPING</span></a>

            <div class="search-bar">
                <input type="text" id="searchInput" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬...">
                <button onclick="searchProduct()"><i class="fas fa-search"></i></button>
            </div>

            <div class="nav-icons">
                <div class="nav-item" onclick="checkMerchantStatus()">
                    <span id="userGreeting">Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</span>
                    <span style="font-weight:bold">Ø­Ø³Ø§Ø¨ÙŠ / Ø¨ÙŠØ¹ Ù…Ø¹Ù†Ø§</span>
                </div>
                <div class="nav-item" onclick="openModal('cartModal')">
                    <i class="fas fa-shopping-cart"></i>
                    <span class="badge" id="cartCount">0</span>
                </div>
            </div>
        </div>
        <div class="sub-header" id="categoryFilters">
            <div class="cat-link active">Ø§Ù„ÙƒÙ„</div>
        </div>
    </header>

    <!-- Slider -->
    <div class="slider-container" id="slider">
        <div class="slide active"
            style="background-image: url('https://images.unsplash.com/photo-1625246333195-f8196812c850?auto=format&fit=crop&w=1600&q=80');">
            <div class="slide-content">
                <h2>Ù…Ù†ØµØ© Ø§Ù„Ù…Ø²Ø§Ø±Ø¹ Ø§Ù„Ø£ÙˆÙ„</h2>
                <p>ÙƒÙ„ Ù…Ø§ ØªØ­ØªØ§Ø¬Ù‡ Ø£Ø±Ø¶Ùƒ ÙÙŠ Ù…ÙƒØ§Ù† ÙˆØ§Ø­Ø¯</p>
                <button class="slide-btn" onclick="document.querySelector('.main-container').scrollIntoView()">ØªØ³ÙˆÙ‚
                    Ø§Ù„Ø¢Ù†</button>
            </div>
        </div>
        <div class="slide"
            style="background-image: url('https://images.unsplash.com/photo-1530836369250-ef72a3f5cda8?auto=format&fit=crop&w=1600&q=80');">
            <div class="slide-content">
                <h2>Ø§Ù†Ø¶Ù… ÙƒØªØ¬Ø§Ø± Ø§Ù„Ø¢Ù†</h2>
                <p>Ø§Ø¹Ø±Ø¶ Ù…Ù†ØªØ¬Ø§ØªÙƒ Ø§Ù„Ø²Ø±Ø§Ø¹ÙŠØ© Ù„Ø¢Ù„Ø§Ù Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</p>
                <button class="slide-btn" onclick="openModal('registerModal')">Ø§Ø´ØªØ±Ùƒ ÙˆØ§Ø¨Ø¯Ø£ Ø§Ù„Ø¨ÙŠØ¹</button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-container">
        <!-- Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„ØªØ§Ø¬Ø± -->
        <div id="merchantDashboard" class="merchant-panel">
            <div class="panel-header">
                <h2 id="dashTitle">Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„ØªØ§Ø¬Ø±</h2>
                <div>
                    <span id="subsStatus" style="font-size:0.9rem; margin-left:10px; font-weight:bold;"></span>
                    <button onclick="logout()"
                        style="background:#c62828; color:white; border:none; padding:5px 15px; border-radius:4px; cursor:pointer">Ø®Ø±ÙˆØ¬</button>
                </div>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                <div>
                    <h3><i class="fas fa-plus-circle"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</h3>
                    <form id="productForm" onsubmit="handleProductSubmit(event)" style="margin-top:15px">
                        <div class="form-group"><input type="text" id="pName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬" required></div>
                        <div class="form-group"><input type="number" id="pPrice" placeholder="Ø§Ù„Ø³Ø¹Ø± (Ø¬Ù†ÙŠÙ‡)" required>
                        </div>
                        <div class="form-group"><input type="text" id="pImg" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© (URL)" required>
                        </div>
                        <div class="form-group">
                            <label>ØªØµÙ†ÙŠÙ Ø§Ù„Ù…Ù†ØªØ¬</label>
                            <input type="text" id="pCat" placeholder="Ù…Ø«Ø§Ù„: Ø¨Ø°ÙˆØ±ØŒ ØªÙ…ÙˆØ±ØŒ Ø£Ø³Ù…Ø¯Ø©..." required>
                        </div>
                        <div class="form-group"><textarea id="pDesc" rows="2" placeholder="ÙˆØµÙ Ø§Ù„Ù…Ù†ØªØ¬"
                                required></textarea></div>
                        <button type="submit" class="btn-primary">Ù†Ø´Ø± Ø§Ù„Ù…Ù†ØªØ¬</button>
                    </form>
                </div>
                <div>
                    <h3><i class="fas fa-box-open"></i> Ù…Ù†ØªØ¬Ø§ØªÙŠ</h3>
                    <div style="max-height:300px; overflow-y:auto; margin-top:10px" id="myProductsList"></div>
                </div>
            </div>
        </div>

        <h2 id="productsTitle" style="margin-bottom:20px; border-bottom:2px solid #ddd; padding-bottom:10px">Ø£Ø­Ø¯Ø«
            Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>
        <div class="products-grid" id="productsContainer"></div>
    </div>

    <!-- Footer -->
    <footer>
        <h3>SHOPPING MARKETPLACE</h3>
        <p>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© &copy; 2025</p>
    </footer>

    <!-- Modals -->

    <div id="authModal" class="modal">
        <div class="modal-content" style="text-align:center">
            <span class="close-modal" onclick="closeModal('authModal')">&times;</span>
            <h2>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ SHOPPING GREEN</h2>
            <p style="margin:15px 0; color:#555">Ù„Ø¨ÙŠØ¹ Ù…Ù†ØªØ¬Ø§ØªÙƒ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ ØªØ§Ø¬Ø±</p>
            <button class="btn-primary" onclick="openModal('loginModal'); closeModal('authModal')"
                style="margin-bottom:10px">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ (ØªØ¬Ø§Ø±)</button>
            <button class="btn-primary" onclick="openModal('registerModal'); closeModal('authModal')"
                style="background:var(--secondary); color:var(--dark)">ØªØ³Ø¬ÙŠÙ„ Ø­Ø³Ø§Ø¨ ØªØ§Ø¬Ø± Ø¬Ø¯ÙŠØ¯</button>
        </div>
    </div>

    <div id="loginModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('loginModal')">&times;</span>
            <h2>ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„ØªØ§Ø¬Ø±</h2>
            <div class="form-group"><label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label><input type="text" id="loginUser"></div>
            <div class="form-group"><label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label><input type="password" id="loginPass"></div>
            <button class="btn-primary" onclick="loginMerchant()">Ø¯Ø®ÙˆÙ„</button>
        </div>
    </div>

    <!-- Register & Payment Modal -->
    <div id="registerModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('registerModal')">&times;</span>
            <h2 id="regTitle">Ø§Ø´ØªØ±Ø§Ùƒ ØªØ§Ø¬Ø± Ø¬Ø¯ÙŠØ¯</h2>
            <div id="step1">
                <div class="form-group"><label>Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¬Ø± (Ø§Ù„Ø¨Ø±Ø§Ù†Ø¯)</label><input type="text" id="regShopName"
                        placeholder="Ø§Ø³Ù… Ù…Ø­Ù„Ùƒ"></div>
                <div class="form-group"><label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ø´Ø®ØµÙŠ</label><input type="tel" id="regPhone"
                        placeholder="01xxxxxxxxx"></div>
                <!-- Ø­Ù‚Ù„ ÙˆØ§ØªØ³Ø§Ø¨ Ø¨Ø²Ù†Ø³ Ø§Ù„Ø¬Ø¯ÙŠØ¯ -->
                <div class="form-group">
                    <label style="color:var(--green-brand)"><i class="fab fa-whatsapp"></i> Ø±Ù‚Ù… ÙˆØ§ØªØ³Ø§Ø¨ (Ù„Ø§Ø³ØªÙ„Ø§Ù…
                        Ø§Ù„Ø·Ù„Ø¨Ø§Øª)</label>
                    <input type="tel" id="regWhatsapp" placeholder="ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¹Ù„ÙŠÙ‡ ÙˆØ§ØªØ³Ø§Ø¨ 01xxxxxxxxx">
                </div>
                <div class="form-group"><label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø¨Ø¯ÙˆÙ† ÙÙˆØ§ØµÙ„)</label><input type="text" id="regUser"
                        placeholder="username"></div>
                <div class="form-group"><label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label><input type="password" id="regPass"
                        placeholder="******"></div>
                <button type="button" class="btn-primary" id="nextBtn" onclick="goToPayment()">Ø§Ù„ØªØ§Ù„ÙŠ: Ø¯ÙØ¹
                    Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</button>
            </div>

            <div id="step2" style="display:none">
                <div class="paywall-msg">
                    <img src="https://instapay.eg/wp-content/uploads/2022/04/instapay-logo.png" class="instapay-logo"
                        alt="Instapay" style="width: 120px;">
                    <h3 style="color:#5a2d81">ØªÙØ¹ÙŠÙ„ Ø­Ø³Ø§Ø¨ Ø§Ù„ØªØ§Ø¬Ø±</h3>
                    <p>Ù‚ÙŠÙ…Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ: <strong style="font-size:1.2rem">100 Ø¬Ù†ÙŠÙ‡ / Ø´Ù‡Ø±ÙŠØ§Ù‹</strong></p>
                    <div
                        style="background:white; padding:10px; border:1px solid #ddd; margin:10px 0; border-radius:5px;">
                        <p style="margin:0; font-size:0.9rem">Ø­ÙˆÙ„ Ø§Ù„Ù…Ø¨Ù„Øº Ø¥Ù„Ù‰ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</p>
                        <h2 style="color:var(--green-brand); letter-spacing:2px; margin:5px 0"
                            onclick="navigator.clipboard.writeText('01120194940'); alert('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ù‚Ù…')">01120194940 <i
                                class="far fa-copy" style="font-size:0.6em; cursor:pointer"></i></h2>
                    </div>
                    <a href="https://play.google.com/store/apps/details?id=com.egyptianbanks.instapay" target="_blank"
                        style="display:block; text-decoration:none; background:#eee; padding:8px; border-radius:5px; color:#333; font-size:0.9rem; margin-bottom:10px">
                        <i class="fas fa-external-link-alt"></i> ÙØªØ­/ØªØ­Ù…ÙŠÙ„ Ø¥Ù†Ø³ØªØ§Ø¨Ø§ÙŠ
                    </a>
                </div>
                <div class="form-group" style="margin-top:15px">
                    <label>Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ© (Reference ID) Ù„Ù„ØªØ£ÙƒÙŠØ¯:</label>
                    <input type="text" id="paymentRef" placeholder="Ù…Ø«Ø§Ù„: 123456789"
                        style="border-color:var(--green-brand)">
                </div>
                <button class="btn-instapay" onclick="completeRegistration()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯ÙØ¹ ÙˆØ¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨</button>
                <button
                    onclick="document.getElementById('step2').style.display='none'; document.getElementById('step1').style.display='block'"
                    style="background:none; border:none; color:#555; margin-top:10px; cursor:pointer; text-decoration:underline">Ø±Ø¬ÙˆØ¹</button>
            </div>
        </div>
    </div>

    <!-- Renewal Modal -->
    <div id="renewalModal" class="modal" style="z-index:3000;">
        <div class="modal-content" style="text-align:center; border-top-color:red;">
            <h2 style="color:red"><i class="fas fa-exclamation-circle"></i> Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</h2>
            <p style="margin:15px 0; font-size:1.1rem">Ø¹ÙÙˆØ§Ù‹ØŒ Ù„Ù‚Ø¯ Ø§Ù†ØªÙ‡Øª ÙØªØ±Ø© Ø§Ø´ØªØ±Ø§ÙƒÙƒ Ø§Ù„Ø´Ù‡Ø±ÙŠØ©.</p>
            <div class="paywall-msg">
                <p>Ù„ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØŒ Ø­ÙˆÙ„ 100 Ø¬Ù†ÙŠÙ‡ Ø¥Ù„Ù‰:</p>
                <h2 style="color:var(--green-brand)">01120194940</h2>
            </div>
            <div class="form-group" style="margin-top:15px; text-align:right">
                <label>Ø±Ù‚Ù… Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:</label>
                <input type="text" id="renewRef" placeholder="Reference ID">
            </div>
            <button class="btn-instapay" onclick="renewSubscription()">ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ø¢Ù†</button>
            <button onclick="closeModal('renewalModal')"
                style="margin-top:10px; background:none; border:none; cursor:pointer">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <!-- Cart Modal -->
    <div id="cartModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('cartModal')">&times;</span>
            <h2><i class="fas fa-shopping-cart"></i> Ø¹Ø±Ø¨Ø© Ø§Ù„ØªØ³ÙˆÙ‚</h2>
            <div id="cartItems" style="margin:20px 0"></div>
            <div style="font-weight:bold; font-size:1.2rem;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <span id="cartTotal">0</span> Ø¬Ù†ÙŠÙ‡</div>
            <hr style="margin:15px 0">
            <h3>Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨</h3>
            <form onsubmit="checkout(event)">
                <div class="form-group"><input type="text" id="cName" placeholder="Ø§Ù„Ø§Ø³Ù…" required></div>
                <div class="form-group"><input type="tel" id="cPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" required></div>
                <div class="form-group"><input type="text" id="cAddress" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§Ù„ØªÙØµÙŠÙ„" required></div>
                <button type="submit" class="btn-primary"
                    style="background:#f0c14b; color:#111; border:1px solid #a88734"><i class="fab fa-check-circle"></i>
                    ØªØ£ÙƒÙŠØ¯ ÙˆÙ…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø·Ù„Ø¨</button>
            </form>
        </div>
    </div>

    <!-- Multi-Vendor Checkout Modal (Ø´Ø§Ø´Ø© ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©) -->
    <div id="dispatchModal" class="modal" style="z-index: 2500;">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('dispatchModal')">&times;</span>
            <h2 style="color:var(--green-brand); text-align:center; margin-bottom:15px"><i class="fab fa-whatsapp"></i>
                Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h2>
            <p style="text-align:center; margin-bottom:20px; font-size:0.9rem; color:#555">Ø³Ù„ØªÙƒ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù…Ù†ØªØ¬Ø§Øª Ù…Ù† ØªØ¬Ø§Ø±
                Ù…Ø®ØªÙ„ÙÙŠÙ†. ÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„ÙƒÙ„ ØªØ§Ø¬Ø± Ø¹Ù„Ù‰ Ø­Ø¯Ø©:</p>

            <div id="dispatchList">
                <!-- Ù‡Ù†Ø§ Ø³ÙŠØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„ÙƒÙ„ ØªØ§Ø¬Ø± -->
            </div>

            <button onclick="closeModal('dispatchModal')"
                style="width:100%; padding:10px; border:1px solid #ddd; background:#fff; margin-top:15px; cursor:pointer">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <script>
        // --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙÙŠØ±Ø¨Ø§Ø³ ---
        const firebaseConfig = {
            apiKey: "AIzaSyBVPsSkWgHqdrQaUwJVcAlWb3iCsrjkgJs",
            authDomain: "store-shopping-a6267.firebaseapp.com",
            databaseURL: "https://store-shopping-a6267-default-rtdb.firebaseio.com",
            projectId: "store-shopping-a6267",
            storageBucket: "store-shopping-a6267.firebasestorage.app",
            messagingSenderId: "362918176320",
            appId: "1:362918176320:web:20de76e9d12e05c6c861a5",
            measurementId: "G-0QQSFTG6EP"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª ---
        let products = [];
        let merchantsMap = {};
        let currentUser = null;
        let cart = [];
        const SUBSCRIPTION_DAYS = 30;

        // --- Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ---
        document.addEventListener("DOMContentLoaded", () => {
            initSlider();

            db.ref('merchants').on('value', snapshot => {
                const merchantsData = snapshot.val() || {};
                merchantsMap = {};
                const now = Date.now();
                for (const [key, val] of Object.entries(merchantsData)) {
                    if (val.expiryDate && val.expiryDate > now) merchantsMap[key] = true;
                    else merchantsMap[key] = false;
                }
                loadProducts();
            });

            const savedUser = sessionStorage.getItem('greenUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                checkSubscriptionOnLoad();
                updateUserUI();
            }
        });

        // --- Ø§Ù„ÙˆØ¸Ø§Ø¦Ù ---
        function loadProducts() {
            db.ref('products').on('value', snapshot => {
                const data = snapshot.val();
                const allProducts = data ? Object.values(data) : [];
                products = allProducts.filter(p => merchantsMap[p.merchantId] === true);
                renderProducts(products);
                updateDynamicFilters();
                if (currentUser) renderMyProducts();
            });
        }

        function updateDynamicFilters() {
            const filterContainer = document.getElementById('categoryFilters');
            const categories = [...new Set(products.map(p => p.cat))];
            let html = `<div class="cat-link active" onclick="filterProducts('all', this)">Ø§Ù„ÙƒÙ„</div>`;
            categories.forEach(cat => { if (cat) html += `<div class="cat-link" onclick="filterProducts('${cat}', this)">${cat}</div>`; });
            filterContainer.innerHTML = html;
        }

        function filterProducts(category, element) {
            document.querySelectorAll('.cat-link').forEach(el => el.classList.remove('active'));
            element.classList.add('active');
            if (category === 'all') {
                renderProducts(products);
                document.getElementById('productsTitle').innerText = "Ø£Ø­Ø¯Ø« Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª";
            } else {
                const filtered = products.filter(p => p.cat === category);
                renderProducts(filtered);
                document.getElementById('productsTitle').innerText = "ØªØµÙ†ÙŠÙ: " + category;
            }
        }

        function renderProducts(list) {
            const container = document.getElementById('productsContainer');
            container.innerHTML = '';
            if (list.length === 0) { container.innerHTML = '<p style="grid-column:1/-1; text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹.</p>'; return; }
            list.forEach(p => {
                container.innerHTML += `
                    <div class="card">
                        <img src="${p.img}" class="card-img" alt="${p.name}" onerror="this.src='https://via.placeholder.com/200?text=No+Image'">
                        <div class="card-body">
                            <div class="cat-badge">${p.cat}</div>
                            <div class="card-title">${p.name}</div>
                            <div class="merchant-badge"><i class="fas fa-store"></i> Ø§Ù„ØªØ§Ø¬Ø±: ${p.shopName || 'Green Golden'}</div>
                            <div class="price">${p.price} <span>Ø¬.Ù…</span></div>
                            <button class="btn-add" onclick="addToCart('${p.id}')">Ø£Ø¶Ù Ù„Ù„Ø¹Ø±Ø¨Ø©</button>
                        </div>
                    </div>
                `;
            });
        }

        // --- Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙˆØ§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ---
        function goToPayment() {
            const name = document.getElementById('regShopName').value;
            const phone = document.getElementById('regPhone').value;
            const whatsapp = document.getElementById('regWhatsapp').value; // Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
            let user = document.getElementById('regUser').value;
            const pass = document.getElementById('regPass').value;

            if (!name || !phone || !whatsapp || !user || !pass) { alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"); return; }
            if (/[.#$\[\]]/.test(user)) { alert("Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø§ ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø±Ù…ÙˆØ² Ø®Ø§ØµØ©"); return; }

            const btn = document.getElementById('nextBtn');
            const originalText = btn.innerText;
            btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...";
            btn.style.opacity = "0.7";

            if (typeof db !== 'undefined') {
                db.ref('merchants/' + user).once('value').then(snapshot => {
                    btn.innerText = originalText;
                    btn.style.opacity = "1";
                    if (snapshot.exists()) { alert("Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø£Ø®ÙˆØ°"); }
                    else {
                        document.getElementById('step1').style.display = 'none';
                        document.getElementById('step2').style.display = 'block';
                        setTimeout(() => document.getElementById('step2').scrollIntoView({ behavior: 'smooth' }), 100);
                    }
                }).catch(e => alert("Ø®Ø·Ø£: " + e.message));
            }
        }

        function completeRegistration() {
            const ref = document.getElementById('paymentRef').value;
            if (!ref) { alert("Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„ØªØ­ÙˆÙŠÙ„"); return; }

            const shopName = document.getElementById('regShopName').value;
            const phone = document.getElementById('regPhone').value;
            const whatsapp = document.getElementById('regWhatsapp').value; // Ø­ÙØ¸ Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨
            const user = document.getElementById('regUser').value;
            const pass = document.getElementById('regPass').value;

            const joinDate = Date.now();
            const expiryDate = joinDate + (SUBSCRIPTION_DAYS * 24 * 60 * 60 * 1000);

            const merchantData = {
                shopName, phone, whatsapp, password: pass, username: user, paymentRef: ref,
                status: 'active', joinDate, expiryDate
            };

            db.ref('merchants/' + user).set(merchantData).then(() => {
                alert("ØªÙ… Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø¨Ù†Ø¬Ø§Ø­!");
                closeModal('registerModal');
                document.getElementById('step1').style.display = 'block';
                document.getElementById('step2').style.display = 'none';
            });
        }

        function loginMerchant() {
            const user = document.getElementById('loginUser').value;
            const pass = document.getElementById('loginPass').value;

            db.ref('merchants/' + user).once('value', snapshot => {
                if (snapshot.exists()) {
                    let data = snapshot.val(); // Ø§Ø³ØªØ®Ø¯Ù…Ù†Ø§ let Ù„ÙŠÙ…ÙƒÙ†Ù†Ø§ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
                    if (data.password == pass) {
                        const now = Date.now();

                        // --- Ø¥ØµÙ„Ø§Ø­ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© (Fix NaN Issue) ---
                        if (!data.expiryDate) {
                            // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ ØªØ§Ø±ÙŠØ®ØŒ Ø§Ù…Ù†Ø­Ù‡ 30 ÙŠÙˆÙ… Ù…Ø¬Ø§Ù†Ø§Ù‹ ÙƒÙØªØ±Ø© ØªØµØ­ÙŠØ­
                            data.expiryDate = now + (SUBSCRIPTION_DAYS * 24 * 60 * 60 * 1000);
                            // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                            db.ref('merchants/' + user).update({ expiryDate: data.expiryDate });
                        }

                        if (data.expiryDate && now > data.expiryDate) {
                            // Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ù…Ù†ØªÙ‡ÙŠ
                            currentUser = data;
                            currentUser.id = user;
                            closeModal('loginModal');
                            openModal('renewalModal');
                        } else {
                            // Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø³Ø§Ø±ÙŠ
                            currentUser = data;
                            currentUser.id = user;
                            sessionStorage.setItem('greenUser', JSON.stringify(currentUser));
                            updateUserUI();
                            closeModal('loginModal');
                            alert("Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ!");
                        }
                    } else {
                        alert("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©");
                    }
                } else {
                    alert("Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
                }
            });
        }

        function checkSubscriptionOnLoad() {
            if (!currentUser) return;
            db.ref('merchants/' + currentUser.id).once('value', snapshot => {
                const data = snapshot.val();
                const now = Date.now();
                if (data && data.expiryDate && now > data.expiryDate) {
                    logout(); openModal('renewalModal');
                }
            });
        }

        function renewSubscription() {
            const newRef = document.getElementById('renewRef').value;
            if (!newRef) { alert("Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„ØªØ­ÙˆÙŠÙ„"); return; }
            const now = Date.now();
            const newExpiry = now + (SUBSCRIPTION_DAYS * 24 * 60 * 60 * 1000);
            db.ref('merchants/' + currentUser.id).update({ expiryDate: newExpiry, lastRenewalRef: newRef, status: 'active' }).then(() => {
                alert("ØªÙ… Ø§Ù„ØªØ¬Ø¯ÙŠØ¯!");
                closeModal('renewalModal');
                currentUser.expiryDate = newExpiry;
                sessionStorage.setItem('greenUser', JSON.stringify(currentUser));
                updateUserUI();
            });
        }

        function logout() {
            currentUser = null;
            sessionStorage.removeItem('greenUser');
            document.getElementById('merchantDashboard').style.display = 'none';
            document.getElementById('userGreeting').textContent = 'Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
        }

        function updateUserUI() {
            document.getElementById('userGreeting').textContent = 'Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ ' + currentUser.shopName;
            document.getElementById('merchantDashboard').style.display = 'block';
            document.getElementById('dashTitle').textContent = "Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ…: " + currentUser.shopName;

            // --- ØªØµØ­ÙŠØ­ Ù…Ø´ÙƒÙ„Ø© NaN ---
            let daysLeft = 0;
            if (currentUser.expiryDate) {
                daysLeft = Math.ceil((currentUser.expiryDate - Date.now()) / (1000 * 60 * 60 * 24));
            } else {
                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø­Ø³Ø§Ø¨ Ù‚Ø¯ÙŠÙ…Ø§Ù‹ ÙˆÙ„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨Ù‡ ØªØ§Ø±ÙŠØ®ØŒ Ù†Ø¹ØªØ¨Ø±Ù‡ 0 Ø£Ùˆ Ù†Ø¹Ø·ÙŠÙ‡ ÙØªØ±Ø© Ø³Ù…Ø§Ø­
                daysLeft = 0;
            }

            // ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø¹Ø±Ø¶: Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø±Ù‚Ù… Ø¨Ø§Ù„Ø³Ø§Ù„Ø¨ (Ù…Ù†ØªÙ‡ÙŠ) ÙŠØ¸Ù‡Ø± 0
            if (daysLeft < 0) daysLeft = 0;

            const statusColor = daysLeft < 5 ? 'red' : 'green';
            const statusText = daysLeft === 0 ? "Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ù…Ù†ØªÙ‡ÙŠ" : `Ø¨Ø§Ù‚ÙŠ: ${daysLeft} ÙŠÙˆÙ…`;

            document.getElementById('subsStatus').innerHTML = `<span style="color:${statusColor}; background:#fff; padding:5px 10px; border-radius:15px; box-shadow:0 2px 5px rgba(0,0,0,0.1)">${statusText}</span>`;

            renderMyProducts();
        }

        function handleProductSubmit(e) {
            e.preventDefault();
            if (!currentUser) return;
            const newProd = {
                id: Date.now(),
                name: document.getElementById('pName').value,
                price: document.getElementById('pPrice').value,
                img: document.getElementById('pImg').value,
                cat: document.getElementById('pCat').value,
                desc: document.getElementById('pDesc').value,
                merchantId: currentUser.id,
                shopName: currentUser.shopName,
                merchantPhone: currentUser.whatsapp || currentUser.phone // Ø­ÙØ¸ Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ù…Ø¹ Ø§Ù„Ù…Ù†ØªØ¬
            };
            db.ref('products/' + newProd.id).set(newProd).then(() => {
                alert("ØªÙ… Ø§Ù„Ù†Ø´Ø±!");
                document.getElementById('productForm').reset();
            });
        }

        function renderMyProducts() {
            const list = document.getElementById('myProductsList');
            list.innerHTML = '';
            db.ref('products').once('value', snapshot => {
                const data = snapshot.val();
                if (data) {
                    const all = Object.values(data);
                    const myProds = all.filter(p => p.merchantId === currentUser.id);
                    myProds.forEach(p => {
                        list.innerHTML += `<div style="display:flex; justify-content:space-between; border-bottom:1px solid #eee; padding:5px;"><span>${p.name}</span><button onclick="deleteProduct(${p.id})" style="color:red; border:none; background:none; cursor:pointer"><i class="fas fa-trash"></i></button></div>`;
                    });
                }
            });
        }

        function deleteProduct(id) { if (confirm("Ø­Ø°ÙØŸ")) db.ref('products/' + id).remove().then(() => renderMyProducts()); }

        // --- Ø§Ù„Ø³Ù„Ø© ÙˆØ§Ù„Ø´Ø±Ø§Ø¡ (Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ø°Ø±ÙŠ) ---
        function addToCart(id) {
            const prod = products.find(p => p.id == id);
            if (!prod) return;
            const exist = cart.find(i => i.id == id);
            if (exist) exist.qty++; else cart.push({ ...prod, qty: 1 });
            updateCartUI();
        }

        function updateCartUI() {
            document.getElementById('cartCount').textContent = cart.reduce((a, b) => a + b.qty, 0);
            let html = ''; let total = 0;
            cart.forEach((item, index) => {
                total += item.price * item.qty;
                html += `<div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #eee"><div>${item.name} (${item.qty})<br><small>${item.shopName}</small></div><div>${item.price * item.qty} <i class="fas fa-times" style="color:red; cursor:pointer" onclick="cart.splice(${index},1);updateCartUI()"></i></div></div>`;
            });
            document.getElementById('cartItems').innerHTML = html || 'ÙØ§Ø±ØºØ©';
            document.getElementById('cartTotal').textContent = total;
        }

        // Ø¯Ø§Ù„Ø© Ø§Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ø·Ù„Ø¨Ø§Øª)
        function checkout(e) {
            e.preventDefault();
            if (cart.length === 0) { alert("Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©"); return; }

            const custName = document.getElementById('cName').value;
            const custPhone = document.getElementById('cPhone').value;
            const custAddr = document.getElementById('cAddress').value;

            // 1. Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù…Ø¬Ù…Ø¹ ÙÙŠ Ø§Ù„Ø£Ø±Ø´ÙŠÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
            const orderId = Date.now();
            db.ref('orders/' + orderId).set({
                date: new Date().toLocaleString(),
                customer: { name: custName, phone: custPhone, address: custAddr },
                cart: cart
            });

            // 2. ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø¬Ø±
            const ordersByMerchant = {};
            cart.forEach(item => {
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… merchantId ÙƒÙ…ÙØªØ§Ø­ Ù„Ù„ØªØ¬Ù…ÙŠØ¹
                if (!ordersByMerchant[item.merchantId]) {
                    ordersByMerchant[item.merchantId] = {
                        shopName: item.shopName,
                        whatsapp: item.merchantPhone, // Ø±Ù‚Ù… ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„ØªØ§Ø¬Ø± Ø§Ù„Ù…Ø®Ø²Ù† Ù…Ø¹ Ø§Ù„Ù…Ù†ØªØ¬
                        items: [],
                        subtotal: 0
                    };
                }
                ordersByMerchant[item.merchantId].items.push(item);
                ordersByMerchant[item.merchantId].subtotal += (item.price * item.qty);
            });

            // 3. Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙˆØ²ÙŠØ¹
            const dispatchList = document.getElementById('dispatchList');
            dispatchList.innerHTML = '';

            for (const [mId, data] of Object.entries(ordersByMerchant)) {
                let msg = `*Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ù…Ù† GREEN GOLDEN*\nğŸ‘¤ Ø§Ù„Ø¹Ù…ÙŠÙ„: ${custName}\nğŸ“± ${custPhone}\nğŸ“ ${custAddr}\n\nğŸ›’ *Ø§Ù„Ø·Ù„Ø¨Ø§Øª:*\n`;
                data.items.forEach(i => {
                    msg += `- ${i.name} (Ø¹Ø¯Ø¯ ${i.qty})\n`;
                });
                msg += `\nğŸ’° *Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: ${data.subtotal} Ø¬Ù†ÙŠÙ‡*`;

                const encodedMsg = encodeURIComponent(msg);
                // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø±Ù‚Ù… ÙˆØ§ØªØ³Ø§Ø¨ØŒ Ù†Ø³ØªØ®Ø¯Ù… Ø±Ù‚Ù… Ø§ÙØªØ±Ø§Ø¶ÙŠ
                const targetPhone = data.whatsapp || "01120194940";

                dispatchList.innerHTML += `
                    <div class="order-split-item">
                        <div class="order-split-header">
                            <span><i class="fas fa-store"></i> Ù…ØªØ¬Ø±: ${data.shopName}</span>
                            <span>${data.subtotal} Ø¬.Ù…</span>
                        </div>
                        <div style="font-size:0.8rem; color:#666; margin-bottom:10px">${data.items.length} Ù…Ù†ØªØ¬Ø§Øª</div>
                        <a href="https://wa.me/${targetPhone}?text=${encodedMsg}" target="_blank" class="whatsapp-btn">
                            <i class="fab fa-whatsapp"></i> Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„ØªØ§Ø¬Ø±
                        </a>
                    </div>
                `;
            }

            closeModal('cartModal');
            openModal('dispatchModal');
            cart = []; updateCartUI(); // ØªÙØ±ÙŠØº Ø§Ù„Ø³Ù„Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ø±Ø¶
        }

        function checkMerchantStatus() {
            if (currentUser) {
                document.getElementById('merchantDashboard').style.display = 'block';
                document.getElementById('merchantDashboard').scrollIntoView({ behavior: 'smooth' });
            } else {
                openModal('authModal');
            }
        }
        function searchProduct() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            const filtered = products.filter(p => p.name.toLowerCase().includes(query) || (p.cat && p.cat.includes(query)));
            renderProducts(filtered);
        }
        function initSlider() {
            const slides = document.querySelectorAll('.slide');
            let current = 0;
            setInterval(() => {
                slides[current].classList.remove('active');
                current = (current + 1) % slides.length;
                slides[current].classList.add('active');
            }, 5000);
        }
        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        window.onclick = function (e) { if (e.target.classList.contains('modal')) e.target.style.display = 'none'; }
    </script>
</body>

</html>
